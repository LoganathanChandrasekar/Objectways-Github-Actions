name: Next.js Frontend CI/CD (Vite)

on:
  workflow_call:
    inputs:
      node-version: { type: string, default: '20' }
      pnpm-version: { type: string, default: '10' }
      working-directory: { type: string, default: 'frontend' }
      aws-region: { type: string, required: true }
      deploy-runner: { type: string, default: 'self-hosted' }
      s3-bucket: { type: string, required: true }
      deploy-path: { type: string, required: true } # BASE directory
      env-source-path: { type: string, required: false }
    secrets:
      aws-role-arn: { required: true }

permissions:
  contents: read
  id-token: write

jobs:
  build-test:
    runs-on: ${{ inputs.deploy-runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: ${{ inputs.pnpm-version }}

      - name: Setup Node & Cache
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f 
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: ${{ inputs.working-directory }}

      - name: Inject Environment
        if: ${{ inputs.env-source-path != '' }}
        run: |
          CLEAN_PATH=$(echo "${{ inputs.env-source-path }}" | xargs)
          if [ -f "$CLEAN_PATH" ]; then
            cp "$CLEAN_PATH" .env
            echo "Env file injected from $CLEAN_PATH"
          else
            echo "Warning: Env file not found at $CLEAN_PATH. Proceeding with system env."
          fi
        working-directory: ${{ inputs.working-directory }}

      - name: Security & Lint
        run: |
          pnpm lint || true
          pnpm audit --audit-level=high 
        working-directory: ${{ inputs.working-directory }}

      - name: Build Vite App
        run: pnpm build
        working-directory: ${{ inputs.working-directory }}

      - name: Prepare Artifact
        run: |
          cd dist
          tar -czf ../release-${{ github.sha }}.tar.gz .
        working-directory: ${{ inputs.working-directory }}

      - name: AWS Auth (OIDC)
        if: ${{ !env.ACT }}
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: ${{ secrets.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Upload to S3
        if: ${{ !env.ACT }}
        run: |
          aws s3 cp release-${{ github.sha }}.tar.gz s3://${{ inputs.s3-bucket }}/frontend/releases/release-${{ github.sha }}.tar.gz
        working-directory: ${{ inputs.working-directory }}

  deploy:
    needs: build-test
    runs-on: ${{ inputs.deploy-runner }}
    steps:
      - name: AWS Auth
        if: ${{ !env.ACT }}
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 
        with:
          role-to-assume: ${{ secrets.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Atomic Deployment
        if: ${{ !env.ACT }}
        shell: bash
        run: |
          BASE_DIR=$(echo "${{ inputs.deploy-path }}" | xargs)
          RELEASE_ID=$(date +%Y%m%d%H%M%S)-${{ github.sha }}
          RELEASES_DIR="$BASE_DIR/releases"
          NEW_RELEASE_DIR="$RELEASES_DIR/$RELEASE_ID"
          CURRENT_LINK="$BASE_DIR/current"
          
          echo "Starting Atomic Deployment for Release: $RELEASE_ID"
          mkdir -p "$RELEASES_DIR"

          # 1. SMART MIGRATION SAFEGUARD (First-run protection)
          # If 'current' is a directory (not a symlink), move it to releases to avoid ln failure
          if [ -d "$CURRENT_LINK" ] && [ ! -L "$CURRENT_LINK" ]; then
            echo "MIGRATION: Existing directory found at $CURRENT_LINK. Moving to releases/legacy_backup."
            mv "$CURRENT_LINK" "$RELEASES_DIR/legacy_backup_$(date +%Y%m%d%H%M%S)"
          fi
          
          # 2. Prepare Workspace
          mkdir -p "$NEW_RELEASE_DIR"
          
          # 3. Fetch Artifact
          aws s3 cp s3://${{ inputs.s3-bucket }}/frontend/releases/release-${{ github.sha }}.tar.gz artifact.tar.gz
          tar -xzf artifact.tar.gz -C "$NEW_RELEASE_DIR"
          rm artifact.tar.gz

          # 4. ATOMIC SWITCH
          ln -sfn "$NEW_RELEASE_DIR" "$CURRENT_LINK"
          
          # 5. Release Retention (Keep last 5)
          echo "Cleaning up old releases..."
          cd "$RELEASES_DIR" && ls -t | grep -v "legacy_backup" | tail -n +6 | xargs rm -rf -- || true
          
          echo "Deployment Successful. Current points to: $(readlink -f $CURRENT_LINK)"
