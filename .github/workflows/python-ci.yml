name: Python CI/CD Template

on:
  workflow_call:
    inputs:
      python-version: { type: string, default: '3.12' }
      working-directory: { type: string, default: '.' }
      aws-region: { type: string, required: true }
      deploy-runner: { type: string, default: 'self-hosted' }
      s3-bucket: { type: string, required: true }
      pm2-name: { type: string, required: true }
      deploy-path: { type: string, required: true }
      env-source-path: { type: string, required: true }
      python-entry-point: { type: string, default: 'app/main.py', description: 'The main Python application entry point for PM2.' }
    secrets:
      aws-role-arn: { required: true }

permissions:
  contents: read
  id-token: write

jobs:
  build-test:
    runs-on: ${{ inputs.deploy-runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        working-directory: ${{ inputs.working-directory }}

      - name: Lint (Ruff)
        run: |
          pip install ruff
          ruff check .
        working-directory: ${{ inputs.working-directory }}

      - name: Test
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pip install pytest
            pytest
          fi
        working-directory: ${{ inputs.working-directory }}

      - name: Prepare Artifact
        run: |
          mkdir -p deploy-package
          # Exclude git, virtualenvs, etc.
          rsync -a ./ deploy-package/ --exclude .git --exclude venv --exclude __pycache__
          cd deploy-package
          tar -czf ../build-${{ github.sha }}.tar.gz .
        working-directory: ${{ inputs.working-directory }}

      - name: AWS Auth
        if: success() && !env.ACT
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: ${{ secrets.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Upload to S3
        if: success() && !env.ACT
        run: |
          aws s3 cp build-${{ github.sha }}.tar.gz s3://${{ inputs.s3-bucket }}/builds/
        working-directory: ${{ inputs.working-directory }}

  deploy:
    needs: build-test
    runs-on: ${{ inputs.deploy-runner }}
    steps:
      - name: AWS Auth
        if: ${{ !env.ACT }}
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: ${{ secrets.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Download & Extract
        if: ${{ !env.ACT }}
        run: |
          rm -rf deploy-temp && mkdir -p deploy-temp
          aws s3 cp s3://${{ inputs.s3-bucket }}/builds/python/build-${{ github.sha }}.tar.gz deploy-temp/artifact.tar.gz
          cd deploy-temp && tar -xzf artifact.tar.gz
          rm artifact.tar.gz

      - name: Deployment
        if: ${{ !env.ACT }}
        shell: bash
        run: |
          TARGET_DIR="${{ inputs.deploy-path }}"
          PM2_NAME="${{ inputs.pm2-name }}"
          ENV_SOURCE="${{ inputs.env-source-path }}"
          
          mkdir -p "$TARGET_DIR"
          rsync -a --delete deploy-temp/ "$TARGET_DIR/"
          
          if [ -f "$ENV_SOURCE" ]; then
            cp "$ENV_SOURCE" "$TARGET_DIR/.env"
          fi
          
          cd "$TARGET_DIR"
          # Try to detect entry point
          ENTRY=$(ls main.py app.py app/main.py 2>/dev/null | head -n 1)
          if [ -z "$ENTRY" ]; then
            echo "No entry point found. Manual PM2 config required."
          else
            if ! pm2 describe "$PM2_NAME" > /dev/null; then
              pm2 start "$ENTRY" --name "$PM2_NAME" --interpreter python3
            else
              pm2 restart "$PM2_NAME" --update-env
            fi
            pm2 save
          fi